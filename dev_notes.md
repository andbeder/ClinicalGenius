# Development Notes - Clinical Genius

**Last Updated**: October 22, 2025

---

## Recent Feature Updates

### Phase 1 HIPAA Compliance Implementation (Oct 22, 2025)

**User Authentication (Single-User Environment Variable Auth):**
- Uses SFDC_USERNAME from .env as authenticated user identity
- Middleware sets `g.current_user` from environment variable
- All audit logs include user identifier
- User displayed in application sidebar
- Appropriate for single-user, localhost-only deployment
- See `HIPAA_AUTHENTICATION.md` for full details

**Localhost-only access:**
- Application restricted to 127.0.0.1 only
- Network access control middleware in app.py
- No external network access - encryption in transit not required

**Database encryption:**
- SQLCipher with AES-256 encryption
- Encryption key stored in `.encryption_key` (permissions: 0600)
- Automatic migration from unencrypted to encrypted database
- Backward compatible with `DB_ENCRYPTION=false` environment variable

**Audit logging:**
- JSON structured logs in `logs/audit.log`
- Database table: `audit_log` with indexed queries
- Logs PHI access, batch executions, access denials, LLM requests
- Rotating file handler (100MB per file, 50 backups = 5GB total)
- All logs include user_id from SFDC_USERNAME

**LLM Provider Access Control:**
- OpenAI provider disabled (no BAA in place)
- Microsoft Copilot allowed (BAA verified)
- LM Studio allowed (localhost only, no BAA needed)
- Code-level blocking with clear error messages
- UI updated to remove OpenAI option

**HTTPS/TLS Implementation:**
- Self-signed SSL certificate for localhost
- TLS 1.2+ encryption for all traffic
- Security headers (HSTS, CSP, X-Frame-Options, etc.)
- Automatic HTTPS detection and configuration
- Certificate generator script: `generate_ssl_cert.py`
- See `HTTPS_SETUP.md` for full details

**Key files:**
- `HIPAA_AUTHENTICATION.md` - User authentication approach documentation
- `HIPAA_BAA_STATUS.md` - Business Associate Agreement tracking
- `HTTPS_SETUP.md` - HTTPS/TLS setup and configuration guide
- `generate_ssl_cert.py` - SSL certificate generation script
- `database/encryption.py` - Encryption key management and SQLCipher connections
- `database/migrate_to_encrypted.py` - Database migration script
- `audit_logger.py` - HIPAA-compliant audit logging system (lines 115-122: user context)
- `app.py` - User context middleware (lines 37-64), Security headers (lines 67-119), HTTPS config (lines 153-182)
- `.encryption_key` - Database encryption key (MUST be backed up securely)
- `ssl/localhost.crt` - SSL certificate (generated by script)
- `ssl/localhost.key` - SSL private key (generated by script, KEEP SECRET)

### Picklist Fields Feature (Oct 22, 2025)
- Select dimension fields as "picklist fields" in dataset configuration
- Fetches distinct values from CRM Analytics using SAQL GROUP BY
- Clicking picklist field in Prompt Builder inserts: `{{Field}} | Value1 | Value2 | Value3`
- Values cached for performance
- Respects dataset SAQL filters
- New endpoint: `POST /api/crm-analytics/datasets/<id>/distinct-values`

### Synthetic Generator - Modular Implementation (Oct 22, 2025)
- Migrated all synthetic routes from monolithic app.py to `routes/synthetic_routes.py`
- Fully functional endpoints:
  - `/api/test-prompt` - Test prompt on single record
  - `/api/batch-generate` - Batch update/insert with LLM
  - `/api/create-record` - Create new Claim__c record
  - `/api/lm-studio/config` - Get/update LM Studio config
- Uses same client injection pattern as other blueprints
- Maintains backward compatibility with existing `/synthetic` UI

### Optional Record ID Filter for Batch Execution (Oct 22, 2025)
- Test batches on small subsets (5-10 records) before full runs
- Supports same delimiters as Proving Ground (newline, comma, tab, space)
- Uses SAQL `in` filter: `'Name' in ["REC-001", "REC-002"]`
- Dataset filters always applied

### SAQL Filter Application (Oct 21, 2025)
- Proving Ground now respects dataset SAQL filters
- Prevents duplicate/incorrect records in filtered datasets
- Filter order: Dataset config filter â†’ Record ID filter

### Nested Object Flattening (Oct 21, 2025)
- Dot notation: `surgeryRelatedDetails.primaryProcedure`
- Makes nested JSON analytics-ready for CSV export
- Consistent between Proving Ground and Batch execution

### Multiple Record ID Query (Oct 21, 2025)
- Uses SAQL `in` operator for batch queries
- Single query for all IDs (vs N individual queries)
- Filters empty values from Excel paste

### Execution Status Persistence (Oct 21, 2025)
- New `execution_status` table persists progress
- Survives server restarts and browser closures
- "View Execution" button in History tab
- Auto-detects active executions on page load

### Wide-Format CSV Export (Oct 21, 2025)
- One row per record (vs long format with one row per parameter)
- Easy to join to source data by Record ID
- Combined CSV merges all batches with column prefixing
- Uses dataset config's `record_id_field`

### Prompt Builder Field Filtering (Oct 21, 2025)
- Shows only selected fields from dataset config
- Added `dataset_config_id` to batches table
- Endpoint: `GET /api/analysis/batches/<batch_id>/fields`

### Proving Ground Enhancements (Oct 21, 2025)
- Multi-delimiter support: comma, tab, space, newline
- Excel copy/paste compatibility
- Server-side SAQL filtering (no memory load)
- Query optimization: only fields used in template

### LLM Response Parsing (Oct 21, 2025)
- Brace-matching algorithm extracts JSON from LM Studio responses
- Removes schema metadata and special tokens
- Ignores thinking text before JSON
- Preview modal: choose specific record or random sample
- SAQL syntax fix: `'FieldName'` not `"FieldName"`
- LM Studio timeout: 600s (10 min)

### Multiple Dataset Management (Oct 21, 2025)
- Migrated from single JSON file to SQLite `dataset_configs` table
- CRUD operations: Create, edit, delete dataset configurations
- Modal UI with field selection, SAQL filter, record ID field
- LLM provider fix: handles `lm_studio` and `lmstudio`
- JSON mode: forces pure JSON output from LM Studio

---

## Core Application Features (Oct 20, 2025)

### Four Main Tabs
1. **Analysis** - Create/manage batches linked to CRM Analytics datasets
2. **Prompt Builder** - Design prompts with `{{field_name}}` variables, AI schema generation
3. **Proving Ground** - Test prompts on specific records before full execution
4. **Batch Execution** - Process thousands of records with real-time progress tracking

### Database Schema
- `batches` - Analysis batch metadata
- `prompts` - Prompt templates, response schemas, LLM config
- `dataset_configs` - Dataset configurations with field selections
- `execution_history` - Completed batch runs with CSV data
- `execution_status` - Active/persisted execution progress

### Key Integrations
- **Salesforce CRM Analytics**: SAQL queries, automatic token refresh
- **Multi-LLM Support**: LM Studio, OpenAI, Microsoft Copilot
- **Background Processing**: Python threading for non-blocking execution
- **CSV Export**: Wide format for analytics-ready output

---

## Synthetic Generator (Oct 19-20, 2025)

Legacy feature at `/synthetic` route for generating AI-powered synthetic data:
- Batch update or create Salesforce records
- Prompt template engine with `{{Field_Name__c}}` syntax
- Deployed 4 Long Text Area fields to Claim__c object
- Bootstrap UI with progress tracking

---

## Technical Stack

### Backend
- Flask 3.0+ with SQLite database
- JWT authentication for Salesforce
- Background threading for batch processing

### Frontend
- Bootstrap 5, vanilla JavaScript
- Single-page app with tab navigation
- Real-time progress polling (2s interval)

### Integrations
- Salesforce: REST API, CRM Analytics SAQL
- LLMs: LM Studio, OpenAI, Microsoft Copilot
- Prompt engine with variable substitution

### Configuration
- `.env` - Credentials and API keys
- `requirements.txt` - Python dependencies
- `force-app/` - Salesforce metadata

---

## Known Limitations

1. **CRM Analytics Upload**: CSV saved to `/tmp/` (External Data API not implemented)
2. **Concurrent Executions**: One batch at a time per server
3. **SAQL Record Limit**: 10,000 records max
4. **Progress Tracking**: Lost on server restart (though now persisted to DB)

## Future Enhancements

- Full External Data API integration
- Parallel record processing (thread pool)
- Prompt template library/versioning
- Additional LLM providers (Claude, Gemini)
- Multi-user authentication and RBAC
